<section *ngIf="roba.length" class="header-margin--top cart">
  <header class="cart-header">
    <div class="cart-header__intro">
      <span *ngIf="isAdmin" class="cart-header__kicker">Admin nabavka</span>
      <h1 class="cart-header__title">{{ isAdmin ? 'Korpa za nabavku' : 'Korpa' }}</h1>
      <p *ngIf="isAdmin" class="cart-header__subtitle">
        Pregled stavki koje idu u internu nabavku.
      </p>
      <p *ngIf="!isAdmin" class="cart-header__subtitle">
        Proverite porudžbinu i nastavite na potvrdu.
      </p>
      <p *ngIf="isAdmin && cartOutOfStockCount" class="cart-header__alert">
        {{ cartOutOfStockCount }} stavki nije na stanju. Proverite eksterni magacin i rokove.
      </p>
    </div>
    <div class="cart-metrics">
      <div class="metric-card">
        <span class="metric-label">Stavke</span>
        <span class="metric-value">{{ cartItemCount }}</span>
      </div>
      <div class="metric-card">
        <span class="metric-label">Količina</span>
        <span class="metric-value">{{ cartQuantityTotal }}</span>
      </div>
      <div class="metric-card" *ngIf="isAdmin">
        <span class="metric-label">Eksterni</span>
        <span class="metric-value">{{ cartProviderCount }}</span>
      </div>
    </div>
  </header>

  <div class="cart-layout">
    <div class="cart-items">
      <div class="cart-items__header">
        <span class="cart-items__ghost" aria-hidden="true"></span>
        <span>Artikal</span>
        <span class="text-right">
          {{ isAdmin ? 'Nabavno / Količina / Ukupno' : 'Cena / Količina / Ukupno' }}
        </span>
        <span class="text-right" aria-hidden="true"></span>
      </div>
      <div class="cart_items">
        <div class="product-row" *ngFor="let row of roba">
          <row
            [data]="row"
            [showPriceOnly]="true"
            [showCloseBtn]="true"
            (removeEvent)="removeFromBasketHandler($event)"
          ></row>
          <div
            *ngIf="isMixedWarehouseItem(row)"
            class="cart-split-info"
            [class.cart-split-info--admin]="isAdmin"
            [class.cart-split-info--customer]="!isAdmin"
          >
            <span class="cart-split-info__header">
              <span class="cart-split-info__square" aria-hidden="true"></span>
              <span class="cart-split-info__text">Isporuka iz više magacina</span>
            </span>
            <span class="cart-split-info__chips" aria-label="Podela količine po magacinima">
              <span class="cart-split-info__chip cart-split-info__chip--local">
                Šabac {{ getMixedLocalQuantity(row) | number : '1.0-0' }} kom
              </span>
              <span class="cart-split-info__chip cart-split-info__chip--external">
                {{ getMixedExternalLabel(row) }} {{ getMixedExternalQuantity(row) | number : '1.0-0' }} kom
              </span>
            </span>
            <span class="cart-split-info__meta" *ngIf="getMixedDeliveryHint(row) as deliveryHint">
              {{ deliveryHint }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <div class="cart-bottom">
      <div class="cart-bottom__form">
        <form *ngIf="loggedIn" class="information cart-panel" [formGroup]="cartForm">
          <h3 class="cart-panel__title">
            {{ isAdmin ? 'Interna napomena' : 'Podaci za isporuku' }}
          </h3>
        <ng-container *ngIf="!isAdmin; else adminCartForm">
        <div class="display--flex gap-7">
          <autom-select
            class="flex--1"
            [label]="'Nacin placanja'"
            [placeholder]="'Izaberite nacin placanja'"
            [required]="true"
            [selectionList]="payingChoices"
            (emitSelected)="setCartSelectionValue('payment', $event.key!)"
            ngDefaultControl
          ></autom-select>
          <autom-select
            class="flex--1"
            [label]="'Nacin transporta'"
            [placeholder]="'Izaberite nacin transporta'"
            [required]="true"
            [selectionList]="transportChoices"
            (emitSelected)="setCartSelectionValue('transport', $event.key!)"
            ngDefaultControl
          ></autom-select>
        </div>
        <autom-input-fields
          [clearBtn]="true"
          [formControlName]="'address'"
          [label]="'Adresa isporuke'"
          [value]="account?.adresa"
          (emitSelected)="setCartSelectionValue('address', $event)"
          ngDefaultControl
        ></autom-input-fields>
        <autom-text-area
          [label]="'Komentar'"
          [placeholder]="'Unesite vas komentar ovde'"
          (emitSelected)="setCartSelectionValue('comment', $event)"
          ngDefaultControl
        ></autom-text-area>
        <autom-input-fields
          class="flex--1"
          [clearBtn]="true"
          [formControlName]="'vin'"
          [label]="'VIN'"
          [placeholder]="'npr. WDBUF56X28B123456'"
          [required]="false"
          [maxLength]="17"
          [attr.aria-describedby]="'vinHelp'"
          (emitSelected)="setUserSelectionValue('vin', $event)"
          ngDefaultControl
        ></autom-input-fields>

        <small id="vinHelp" class="form-hint">
          <strong>Opciono polje:</strong> Ako unesete VIN broj, naš tim može uz
          pomoć profesionalnih alata proveriti da li deo koji ste pronašli zaista
          odgovara vašem vozilu. Za isti model automobila može postojati više
          različitih varijanti delova iz mnogo razloga (oprema, motor, godina,
          tržište…). VIN nam omogućava da budete sigurni u ispravnost izbora.
        </small>
      </ng-container>
      <ng-template #adminCartForm>
        <div *ngIf="shouldShowFebiDeliveryOptions" class="provider-delivery">
          <autom-radio-button
            [label]="'Febi - nacin isporuke'"
            [options]="febiDeliveryOptions"
            [displaySubtitle]="true"
            [theme]="orientation.VERTICAL"
            (emitSelected)="onFebiDeliveryPartySelected($event)"
          ></autom-radio-button>
          <small class="provider-delivery__hint">
            Opcija vazi samo za Febi artikle u korpi.
          </small>
        </div>
        <autom-text-area
          [label]="'Komentar'"
          [placeholder]="'Unesite komentar za internu porudzbinu'"
          (emitSelected)="setCartSelectionValue('comment', $event)"
          ngDefaultControl
        ></autom-text-area>
      </ng-template>
      </form>
      <form *ngIf="!loggedIn" class="information cart-panel" [formGroup]="userForm">
        <h3 class="cart-panel__title">Podaci kupca</h3>
        <div class="display--flex gap-7">
          <autom-input-fields
            class="flex--1"
            [clearBtn]="true"
            [formControlName]="'name'"
            [label]="'Ime'"
            [required]="true"
            (emitSelected)="setUserSelectionValue('name', $event)"
            ngDefaultControl
          ></autom-input-fields>
          <autom-input-fields
            class="flex--1"
            [clearBtn]="true"
            [formControlName]="'surname'"
            [label]="'Prezime'"
            [required]="true"
            (emitSelected)="setUserSelectionValue('surname', $event)"
            ngDefaultControl
          ></autom-input-fields>
        </div>
        <div class="display--flex gap-7">
          <autom-input-fields
            class="flex--1"
            [clearBtn]="true"
            [formControlName]="'postalcode'"
            [label]="'Postal code'"
            [required]="true"
            (emitSelected)="setUserSelectionValue('postalcode', $event)"
            ngDefaultControl
          ></autom-input-fields>
          <autom-input-fields
            class="flex--1"
            [clearBtn]="true"
            [formControlName]="'city'"
            [label]="'Grad'"
            [required]="true"
            (emitSelected)="setUserSelectionValue('city', $event)"
            ngDefaultControl
          ></autom-input-fields>
        </div>
        <div class="display--flex gap-7">
          <autom-input-fields
            class="flex--1"
            [clearBtn]="true"
            [formControlName]="'street'"
            [label]="'Ulica i broj'"
            [required]="true"
            (emitSelected)="setUserSelectionValue('street', $event)"
            ngDefaultControl
          ></autom-input-fields>
          <autom-input-fields
            class="flex--1"
            [clearBtn]="true"
            [formControlName]="'phone'"
            [label]="'Telefon'"
            [required]="true"
            (emitSelected)="setUserSelectionValue('phone', $event)"
            ngDefaultControl
          ></autom-input-fields>
        </div>
        <autom-input-fields
          [clearBtn]="true"
          [formControlName]="'email'"
          [id]="'email'"
          [label]="'Email'"
          [required]="true"
          [type]="inputTypeEnum.EMAIL"
          [validators]="[
            {
              name: 'pattern',
              value: emailAddressPattern
            }
          ]"
          (emitSelected)="setUserSelectionValue('email', $event)"
          ngDefaultControl
        ></autom-input-fields>
        <autom-input-fields
          [clearBtn]="true"
          [formControlName]="'pib'"
          [label]="'PIB'"
          (emitSelected)="setUserSelectionValue('pib', $event)"
          ngDefaultControl
        ></autom-input-fields>
        <autom-text-area
          [label]="'Komentar'"
          [placeholder]="'Unesite vas komentar ovde'"
          (emitSelected)="setUserSelectionValue('comment', $event)"
          ngDefaultControl
        ></autom-text-area>
        <autom-input-fields
          class="flex--1"
          [clearBtn]="true"
          [formControlName]="'vin'"
          [label]="'VIN'"
          [placeholder]="'npr. WDBUF56X28B123456'"
          [required]="false"
          [maxLength]="17"
          [attr.aria-describedby]="'vinHelp'"
          (emitSelected)="setUserSelectionValue('vin', $event)"
          ngDefaultControl
        ></autom-input-fields>

        <small id="vinHelp" class="form-hint">
          <strong>Opciono polje:</strong> Ako unesete VIN broj, naš tim može uz
          pomoć profesionalnih alata proveriti da li deo koji ste pronašli zaista
          odgovara vašem vozilu. Za isti model automobila može postojati više
          različitih varijanti delova iz mnogo razloga (oprema, motor, godina,
          tržište…). VIN nam omogućava da budete sigurni u ispravnost izbora.
        </small>
      </form>
      </div>

      <aside class="cart-summary">
        <div *ngIf="total" class="total cart-panel">
        <div class="cart-summary__header">
          <p class="cart-summary__title">Rezime porudžbine</p>
          <p class="cart-summary__subtitle">
            {{ cartItemCount }} stavki • {{ cartQuantityTotal }} kom
          </p>
        </div>
        <table class="cart-summary__table">
          <tr>
            <td>{{ isAdmin ? 'Nabavno bez PDV-a:' : 'Bez PDV-a:' }}</td>
            <td class="price cart-summary__value">{{ bezPdv | rsdCurrency }}</td>
          </tr>
          <tr>
            <td>PDV:</td>
            <td class="price cart-summary__value">{{ pdv | rsdCurrency }}</td>
          </tr>
          <tr class="cart-summary__total">
            <td>{{ isAdmin ? 'Ukupno nabavno sa PDV-om:' : 'Ukupno sa PDV-om:' }}</td>
            <td class="price cart-summary__value">{{ total | rsdCurrency }}</td>
          </tr>
        </table>

        <div *ngIf="!isAdmin && shouldShowMixedDeliveryInfo" class="checkout-info">
          <p class="checkout-info__title">Isporuka</p>
          <ul class="checkout-info__list">
            <li>Podrazumevano šaljemo kada sve stavke stignu.</li>
            <li *ngIf="deliveryEstimateLabel; else unknownDelivery">
              Procena isporuke: {{ deliveryEstimateLabel }}.
            </li>
            <ng-template #unknownDelivery>
              <li>Procena isporuke se potvrđuje nakon obrade porudžbine.</li>
            </ng-template>
            <li>
              Ako želite delimičnu isporuku (više paketa), napišite u napomeni.
            </li>
            <li>Dodatna poštarina može važiti za više paketa.</li>
          </ul>
        </div>

        <div *ngIf="hasNonReturnableItems" class="checkout-info">
          <p class="checkout-info__title">Napomena</p>
          <autom-meta-pill
            variant="warning"
            size="md"
            [label]="'Ne može povrat'"
            [attr.title]="'Stavke označene kao non-returnable ne mogu se stornirati.'"
            [ariaLabel]="'Ne može povrat'"
          ></autom-meta-pill>
        </div>

        <div *ngIf="hasNonReturnableItems" class="free-shipping-info warning">
          <autom-icon [source]="iconsEnum.INFO" class="info-icon"></autom-icon>
          Stavke označene kao non-returnable ne mogu se stornirati.
        </div>

        <autom-button
          class="autom-align__right order-btn"
          [type]="buttonTypes.PRIMARY"
          [theme]="buttonThemes.LIGHT_ORANGE"
          [label]="'Potvrdi porudzbinu'"
          [disabled]="
            invoiceSubmitted || (loggedIn ? !cartForm.valid : !userForm.valid)
          "
          (clickEvent)="submitInvoice()"
        ></autom-button>
        <div *ngIf="!isAdmin && hasProviderOnlyItems" class="free-shipping-info warning">
          <autom-icon [source]="iconsEnum.INFO" class="info-icon"></autom-icon>
          Korpa sadrži stavke iz eksternog magacina. Te stavke mogu imati duži rok
          isporuke.
        </div>
        <div
          *ngIf="!isAdmin && !loggedIn && total < 3000"
          class="free-shipping-info warning"
        >
          <autom-icon [source]="iconsEnum.INFO" class="info-icon"></autom-icon>
          Porudžbine preko 3.000 RSD (kupci bez ugovora) imaju besplatnu
          dostavu. Još {{ 3000 - total | rsdCurrency }} i vaša dostava će biti
          besplatna!
        </div>
        <div *ngIf="!isAdmin && !loggedIn" class="checkout-info">
          <p class="checkout-info__title">Dostava i plaćanje</p>
          <ul class="checkout-info__list">
            <li>
              Artikle sa stanja predajemo kuriru u roku od 24h (Aks/Bex dostava
              1–2 radna dana).
            </li>
            <li>
              Ako neki artikal nije na stanju, obezbeđujemo ga iz eksternog
              magacina (rok isporuke može biti duži).
            </li>
            <li>
              Plaćanje pouzećem (gotovina ili kartica kod kurira gde je
              omogućeno).
            </li>
            <li>Fiskalni račun stiže u paketu.</li>
            <li>
              Ako ste na ruti našeg vozila tog dana, javljamo se ili pozovite za
              direktnu isporuku.
            </li>
            <li>
              Besplatna dostava za maloprodajne online porudžbine (bez ugovora)
              iznad 3.000 RSD.
            </li>
          </ul>
          <div class="checkout-info__links">
            <a
              routerLink="/uslovi-kupovine"
              fragment="dostava"
              href="/uslovi-kupovine#dostava"
              >Dostava</a
            >
            <span aria-hidden="true">•</span>
            <a
              routerLink="/uslovi-kupovine"
              fragment="placanje"
              href="/uslovi-kupovine#placanje"
              >Plaćanje</a
            >
            <span aria-hidden="true">•</span>
            <a
              routerLink="/uslovi-kupovine"
              fragment="povrat"
              href="/uslovi-kupovine#povrat"
              >Povrat i garancija</a
            >
          </div>
        </div>

        <div
          *ngIf="!isAdmin && !loggedIn && total >= 3000"
          class="free-shipping-info success"
        >
          <autom-icon
            [source]="iconsEnum.CHECK_CIRCLE"
            class="info-icon"
          ></autom-icon>
          Obezbedili ste besplatnu dostavu!
        </div>
        </div>
      </aside>
    </div>
  </div>
</section>
<section *ngIf="!roba.length" class="util__flex--center">
  <div class="mobile-empty-page util__flex--center util__height no-result">
    <h5>
      <autom-icon [source]="iconsEnum.SHOPPING_CART"></autom-icon> Vasa korpa je
      prazna
    </h5>
    <autom-button
      [routerLink]="['/webshop']"
      [type]="buttonTypes.PRIMARY"
      [theme]="buttonThemes.LIGHT_ORANGE"
      [label]="'Posetite nas katalog'"
    >
    </autom-button>
  </div>
</section>
