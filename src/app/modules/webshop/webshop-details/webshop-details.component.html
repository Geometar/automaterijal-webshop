<section class="section" [class.section--loading]="loading">
  <ng-container *ngIf="!loading; else productSkeleton">
    <div class="product-container">
      <div class="product-header">
        <div class="product-heading">
          <h1 class="product-title" aria-label="Naziv proizvoda">
            {{ data.proizvodjac?.naziv }} {{ data.naziv }}
          </h1>
          <p class="product-article" *ngIf="data.katbr">
            Kat br: {{ data.katbr }}
          </p>
        </div>
        <autom-button
          *ngIf="shareLink"
          class="product-share-button"
          [type]="buttonType.SECONDARY"
          [iconPrefix]="true"
          [iconSource]="iconEnum.SHARE"
          [iconColor]="colorEnum.INFO_25_FILL"
          [label]="'Podeli proizvod'"
          (clickEvent)="shareProduct()"
        ></autom-button>
      </div>

      <article class="product-details">
        <div class="product-hero">
          <!-- Slika / gallery -->
          <figure class="product-media">
            <img
              class="product-img"
              [src]="getPrimaryImageSrc()"
              [alt]="getPrimaryImageAlt()"
              [title]="getPrimaryImageTitle()"
              decoding="async"
              fetchpriority="high"
            />
            <figcaption *ngIf="data?.proizvodjacLogo" class="media-caption">
              <img
                *ngIf="data?.proizvodjacLogo"
                class="brand-logo"
                [src]="data!.proizvodjacLogo"
                [alt]="'Logo ' + (data.proizvodjac!.naziv || '')"
              />
            </figcaption>
          </figure>

          <!-- Specifikacije -->
          <aside
            *ngIf="hasSpecs; else fallbackHighlights"
            class="product-specs card"
            [attr.aria-labelledby]="specTitleId"
          >
            <header class="specs-header">
              <h2 class="specs-title" [id]="specTitleId">Specifikacije</h2>
              <span *ngIf="specOverflow && !showAllSpecs" class="specs-count"
                >+{{ specOverflow }} dodatnih stavki</span
              >
            </header>

            <table class="specs-table">
              <caption class="sr-only">
                Specifikacije proizvoda
              </caption>
              <tbody>
                <tr
                  *ngFor="let spec of displayedSpecs; trackBy: trackSpec"
                  [class.spec-highlight]="spec.highlight"
                >
                  <th scope="row">
                    <span>{{ spec.oznaka }}</span>
                    <span *ngIf="spec.jedinica" class="spec-unit"
                      >[{{ spec.jedinica }}]</span
                    >
                  </th>
                  <td class="spec-value">
                    <span>{{ spec.vrednost }}</span>
                  </td>
                </tr>
              </tbody>
            </table>

            <div class="spec-toggle" *ngIf="specOverflow > 0">
              <autom-button
                [label]="
                  showAllSpecs ? 'Prikaži manje' : 'Prikaži sve specifikacije'
                "
                [type]="buttonType.TERNARY"
                (clickEvent)="toggleSpecs()"
              ></autom-button>
            </div>
          </aside>

          <ng-template #fallbackHighlights>
            <aside
              class="product-highlights card"
              aria-label="Istaknute informacije"
            >
              <p class="specs-fallback">
                <autom-icon
                  [source]="iconEnum.INFO"
                  class="specs-info-icon"
                ></autom-icon>
                Specifikacije nisu dostupne za ovaj artikal.
              </p>
              <ul class="bullets">
                <li *ngIf="data.proizvodjac?.naziv">
                  <i class="dot"></i
                  ><strong>{{ data.proizvodjac?.naziv }}</strong> — pouzdan
                  brend
                </li>
                <li *ngIf="data.grupaNaziv">
                  <i class="dot"></i>{{ data.grupaNaziv }}
                  <span *ngIf="data.podGrupaNaziv"
                    >› {{ data.podGrupaNaziv }}</span
                  >
                </li>
                <li *ngIf="availabilityStatus === 'IN_STOCK'">
                  <i class="dot"></i>Na stanju — spremno za brzu isporuku
                </li>
                <li *ngIf="availabilityStatus === 'AVAILABLE'">
                  <i class="dot"></i>{{ availabilityLabel }}<span *ngIf="providerDeliveryLabel">
                    — isporuka {{ providerDeliveryLabel }}</span
                  >
                </li>
                <li *ngIf="availabilityStatus === 'OUT_OF_STOCK'">
                  <i class="dot"></i>Nema na stanju
                </li>
                <li *ngIf="data.katbr">
                  <i class="dot"></i>Kat. broj: {{ data.katbr }}
                </li>
                <li *ngIf="availabilityVm.provider.coreCharge">
                  <i class="dot"></i>
                  Kaucija: {{ availabilityVm.provider.coreCharge | rsdCurrency }}
                </li>
              </ul>
            </aside>
          </ng-template>

          <!-- Kupovna kartica (sticky) -->
          <aside class="buy-card card">
            <div
              class="stock"
              [class.ok]="hasValidPrice && availabilityStatus === 'IN_STOCK'"
              [class.supplier]="hasValidPrice && availabilityStatus === 'AVAILABLE' && isStaff"
              [class.external]="hasValidPrice && availabilityStatus === 'AVAILABLE' && !isStaff"
              [class.nope]="!hasValidPrice || availabilityStatus === 'OUT_OF_STOCK'"
            >
              {{ availabilityLabel }}<span class="led" aria-hidden="true"></span>
            </div>

            <autom-provider-availability
              [availability]="availabilityVm"
              [isStaff]="isStaff"
              [showQuantity]="availabilityVm.provider.admin.isAdmin"
              variant="details"
            ></autom-provider-availability>

            <div class="price-wrap">
              <ng-container *ngIf="availabilityVm.priceVerified; else unverifiedPrice">
                <div class="price-row" *ngIf="hasDiscount">
                  <span class="old-price">{{ oldPrice! | rsdCurrency }}</span>
                  <span class="discount-badge">-{{ discountValue }}%</span>
                </div>
                <div class="price">{{ displayPrice | rsdCurrency }}</div>
                <div class="note">cena po komadu</div>
                <div *ngIf="availabilityVm.provider.coreCharge" class="note note--core">
                  Kaucija: {{ availabilityVm.provider.coreCharge | rsdCurrency }}
                </div>
                <div class="total-price">
                  Ukupno: {{ totalPrice | rsdCurrency }}
                </div>
                <div *ngIf="hasDiscount && savings" class="saving">
                  Ušteda {{ savings! | rsdCurrency }}
                </div>
              </ng-container>
              <ng-template #unverifiedPrice>
                <div class="price">Cena nije proverena</div>
                <div class="note">Proveri dostupnost pre poručivanja</div>
              </ng-template>
            </div>

            <div class="actions">
              <autom-input-fields
                [clearBtn]="false"
                [disableInput]="isOutOfStock || requiresLoginForOrder"
                [customClass]="'qty'"
                [max]="availableStock || quantityMin"
                [min]="quantityMin"
                [roundOff]="true"
                [size]="sizeEnum.MEDIUM"
                [type]="inputTypeEnum.QUANTITY"
                [validators]="[
                  { name: 'max', value: availableStock || quantityMin },
                  { name: 'min', value: quantityMin }
                ]"
                [step]="quantityStep"
                [value]="quantity"
                (emitSelected)="modifyQuantity($event)"
                ngDefaultControl
              ></autom-input-fields>

              <autom-button
                [disabled]="isOutOfStock || requiresLoginForOrder"
                [theme]="requiresLoginForOrder ? buttonTheme.LIGHT_RED : buttonTheme.DEFAULT"
                [iconPrefix]="true"
                [iconSource]="iconEnum.SHOPPING_CART"
                [iconColor]="colorEnum.INFO_25_FILL"
                [label]="'Dodaj u korpu'"
                (clickEvent)="addToShopingCart()"
              ></autom-button>
            </div>
            <p *ngIf="requiresLoginForOrder" class="login-note">
              Dozvoljeno samo ulogovanim kupcima
            </p>

            <div *ngIf="isOutOfStock" class="inquiry">
              <p class="inquiry__title" *ngIf="!inquirySent">
                {{
                  showProviderAvailability
                    ? 'Dostupno u eksternom magacinu — pošalji upit za nabavku'
                    : 'Nema na stanju? Pošalji upit za nabavku'
                }}
              </p>
              <p class="inquiry__title success" *ngIf="inquirySent">
                Upit poslat. Javićemo se uskoro.
              </p>

              <ng-container *ngIf="!inquirySent; else inquirySentBlock">
                <autom-input-fields
                  *ngIf="!loggedIn"
                  [label]="'Email (obavezno)'"
                  [placeholder]="'Unesi email da ti odgovorimo'"
                  [value]="inquiryContact"
                  [size]="sizeEnum.FULL"
                  [type]="inputTypeEnum.EMAIL"
                  [maxLength]="120"
                  [required]="true"
                  (emitSelected)="onInquiryContactChange($event)"
                  ngDefaultControl
                ></autom-input-fields>

                <autom-input-fields
                  *ngIf="!loggedIn"
                  [label]="'Telefon (opciono)'"
                  [placeholder]="'Unesi telefon za brži kontakt'"
                  [value]="inquiryPhone"
                  [size]="sizeEnum.FULL"
                  [type]="inputTypeEnum.TEXT"
                  [maxLength]="30"
                  (emitSelected)="onInquiryPhoneChange($event)"
                  ngDefaultControl
                ></autom-input-fields>

                <autom-text-area
                  [label]="'Napomena (opciono)'"
                  [rows]="3"
                  [maxLength]="300"
                  [value]="inquiryNote"
                  [placeholder]="'Npr. treba mi rok isporuke ili količina...'"
                  (emitSelected)="onInquiryNoteChange($event)"
                ></autom-text-area>

                <div class="inquiry__actions">
                  <autom-button
                    [iconPrefix]="true"
                    [iconSource]="iconEnum.MAIL"
                    [label]="'Pošalji upit'"
                    [disabled]="inquirySending || (!loggedIn && !inquiryContactTrim)"
                    [theme]="buttonTheme.DEFAULT"
                    [type]="buttonType.PRIMARY"
                  (clickEvent)="sendInquiry()"
                ></autom-button>
                <span class="inquiry__hint">
                    Odgovaramo na {{ loggedIn && inquiryContact ? 'email sa naloga' : 'email koji ostaviš' }}.
                  </span>
                </div>
              </ng-container>

              <ng-template #inquirySentBlock>
                <div class="inquiry__sent-note">
                  <autom-icon [source]="iconEnum.CHECK_CIRCLE" class="ok-icon"></autom-icon>
                  Upit je primljen. Bićeš kontaktiran na {{ inquiryContact }}.
                </div>
              </ng-template>
            </div>

            <div *ngIf="!loggedIn" class="delivery-hint">
              <p class="delivery-hint__title">Dostava i plaćanje</p>
              <ul class="delivery-hint__list">
                <li>
                  Sve na stanju → kuriru u 24h, Aks/Bex isporuka 1–2 radna dana.
                </li>
                <li>
                  Plaćanje pouzećem (gotovina/kartica gde je omogućeno);
                  fiskalni račun je u paketu.
                </li>
                <li>
                  Na ruti smo tog dana? Javljamo se ili pozovite za direktnu
                  isporuku.
                </li>
                <li>
                  Besplatna dostava za maloprodajne porudžbine (bez ugovora)
                  iznad 3.000 RSD.
                </li>
              </ul>
              <div class="delivery-hint__links">
                <a
                  routerLink="/uslovi-kupovine"
                  fragment="dostava"
                  href="/uslovi-kupovine#dostava"
                  >Detalji dostave</a
                >
                <span aria-hidden="true">•</span>
                <a
                  routerLink="/uslovi-kupovine"
                  fragment="placanje"
                  href="/uslovi-kupovine#placanje"
                  >Plaćanje</a
                >
                <span aria-hidden="true">•</span>
                <a
                  routerLink="/uslovi-kupovine"
                  fragment="povrat"
                  href="/uslovi-kupovine#povrat"
                  >Povrat i garancija</a
                >
              </div>
            </div>
          </aside>
        </div>
      </article>

      <app-vehicle-compatibility
        *ngIf="data?.linkedManufacturers?.length"
        [product]="data"
        (targetsChange)="onCompatibilityTargetsChange($event)"
      ></app-vehicle-compatibility>

      <app-product-documentation
        [groups]="documentationGroups"
        [pdfTooltip]="pdfTooltip"
        (openPdf)="openPdf($event)"
        (openLink)="openLink($event)"
      ></app-product-documentation>

      <app-product-oe-numbers
        [entries]="oeNumberEntries"
      ></app-product-oe-numbers>

      <div *ngIf="!editingText" class="product-container documentation">
        <h3 class="oe-title" *ngIf="data.tekst || !data.tehnickiOpis?.length">
          Informacije o proizvodu
        </h3>

        <!-- Ako postoji tekst -->
        <div
          *ngIf="data.tekst; else checkSpecs"
          class="product-rich-text"
          [innerHTML]="sanitizedText"
          aria-label="Detaljan opis proizvoda"
        ></div>

        <!-- Ako nema tekst, proveri specifikacije -->
        <ng-template #checkSpecs>
          <!-- Ako postoje specifikacije, ne prikazujemo ništa -->
          <ng-container
            *ngIf="data.tehnickiOpis?.length; else noDescription"
          ></ng-container>
        </ng-template>

        <!-- Ako nema ni tekst ni specifikacije -->
        <ng-template #noDescription>
          <p class="product-fallback">
            Detaljan opis trenutno nije dostupan za ovaj proizvod. Kontaktirajte
            nas za dodatne informacije ili tehničke detalje.
          </p>
        </ng-template>
      </div>

      <autom-divider *ngIf="showcaseDataCategories.length"></autom-divider>

      <autom-showcase
        *ngIf="showcaseDataCategories.length"
        [showcase]="showcaseDataCategories"
        [loading]="loading"
      ></autom-showcase>

      <autom-showcase
        *ngIf="showcaseDataManufactures.length"
        [showcase]="showcaseDataManufactures"
        [loading]="loading"
      ></autom-showcase>

      <div *ngIf="editingText" class="product-container documentation">
        <h3 class="oe-title">Informacije o proizvodu</h3>
        <autom-text-area
          [placeholder]="'Unesite vas opis ovde'"
          [value]="data.tekst!"
          [maxLength]="2000"
          [editable]="true"
          (emitSelected)="textChanged($event)"
        ></autom-text-area>
        <div *ngIf="editingText" class="edit-description-actions">
          <autom-button
            [label]="'Otkaži'"
            [theme]="buttonTheme.LIGHT_GREY"
            [type]="buttonType.TERNARY"
            (clickEvent)="cancelTextEdit()"
          ></autom-button>
          <autom-button
            [label]="'Sačuvaj opis'"
            [theme]="buttonTheme.DEFAULT"
            [type]="buttonType.PRIMARY"
            (clickEvent)="saveTextDescription()"
          ></autom-button>
        </div>
      </div>
      <div *ngIf="isAdmin && data?.robaid" class="admin-edit-footer">
        <h3 class="admin-edit-title">Admin tools</h3>
        <div class="admin-edit-actions">
          <autom-button
            [label]="'Upload image'"
            [iconSource]="iconEnum.IMAGE"
            [iconColor]="colorEnum.INFO_25"
            [iconPrefix]="true"
            [theme]="buttonTheme.LIGHT_ORANGE"
            [type]="buttonType.PRIMARY"
            (clickEvent)="triggerImageUpload()"
          ></autom-button>

          <autom-button
            [label]="'Edit attributes'"
            [iconSource]="iconEnum.SETTINGS"
            [iconColor]="colorEnum.INFO_25"
            [iconPrefix]="true"
            [theme]="buttonTheme.LIGHT_ORANGE"
            [type]="buttonType.PRIMARY"
            (clickEvent)="editAttributes()"
          ></autom-button>

          <autom-button
            [label]="'Edit description'"
            [iconSource]="iconEnum.EDIT"
            [iconColor]="colorEnum.INFO_25"
            [iconPrefix]="true"
            [theme]="buttonTheme.LIGHT_ORANGE"
            [type]="buttonType.PRIMARY"
            (clickEvent)="editDescription()"
          ></autom-button>

          <autom-button
            [label]="'Izbrisi svu dokumentaciju'"
            [iconSource]="iconEnum.DELETE"
            [iconColor]="colorEnum.INFO_25"
            [iconPrefix]="true"
            [theme]="buttonTheme.DARK_RED"
            [type]="buttonType.PRIMARY"
            (clickEvent)="showDeleteWarningPopup = true"
          ></autom-button>

          <autom-button
            [label]="'Izbrisi sliku'"
            [iconSource]="iconEnum.DELETE"
            [iconColor]="colorEnum.INFO_25"
            [iconPrefix]="true"
            [theme]="buttonTheme.DARK_RED"
            [type]="buttonType.PRIMARY"
            (clickEvent)="showImageDeleteWarningPopup = true"
          ></autom-button>
        </div>

        <!-- Hidden file input for image upload -->
        <input
          type="file"
          id="imageUpload"
          accept="image/*"
          (change)="onImageSelected($event)"
          hidden
        />
      </div>
    </div>
  </ng-container>
</section>

<ng-template #productSkeleton>
  <div class="product-container skeleton">
    <div class="product-header">
      <div class="skeleton-line skeleton-line--title"></div>
      <div class="skeleton-line skeleton-line--muted"></div>
    </div>

    <div class="product-hero skeleton-hero-grid">
      <figure class="product-media skeleton-media">
        <div
          class="skeleton-block skeleton-block--image"
          aria-hidden="true"
        ></div>
      </figure>

      <aside class="product-specs card skeleton-card" aria-hidden="true">
        <div class="skeleton-line skeleton-line--heading"></div>
        <div class="skeleton-table">
          <div class="skeleton-row" *ngFor="let _ of skeletonRows">
            <div class="skeleton-cell"></div>
            <div class="skeleton-cell skeleton-cell--value"></div>
          </div>
        </div>
        <div class="skeleton-line skeleton-line--button"></div>
      </aside>

      <aside class="buy-card card skeleton-card" aria-hidden="true">
        <div class="skeleton-line skeleton-line--price"></div>
        <div class="skeleton-line skeleton-line--text"></div>
        <div class="skeleton-line skeleton-line--button"></div>
        <div class="skeleton-line skeleton-line--button"></div>
      </aside>
    </div>

    <div
      class="product-container documentation skeleton-stack"
      aria-hidden="true"
    >
      <div class="skeleton-line skeleton-line--heading"></div>
      <div class="skeleton-line skeleton-line--text"></div>
      <div class="skeleton-line skeleton-line--text"></div>
    </div>
  </div>
</ng-template>

<add-attributes
  *ngIf="showAddAttributes"
  [data]="data"
  (close)="showAddAttributes = false"
  (saved)="refreshDetails()"
></add-attributes>

<autom-popup
  *ngIf="showDeleteWarningPopup"
  class="logout-popup"
  [height]="sizeEnum.AUTO"
  [position]="positionEnum.CENTER"
  [rounded]="true"
  [subPosition]="positionEnum.CENTER"
  [width]="sizeEnum.MEDIUM"
>
  <div custom-body class="confirmation-container">
    <div class="confirmation-container__icon">
      <autom-icon
        class="confirmation-container__icon--circle"
        [source]="iconEnum.ALERT_TRIANGLE"
      ></autom-icon>
    </div>
    <div class="confirmation-container__main">
      <div class="confirmation-container__header">
        <h2 class="h2">Obaveštenje</h2>
      </div>
      <div class="confirmation-container__body">
        <h5>
          Da li ste sigurni da želite da se izbrišete atribute i dokumentaciju
          artikla?
        </h5>
      </div>
      <div class="confirmation-container__footer">
        <div>
          <autom-button
            class="warning-popup__cancel-button"
            [label]="'Odustani'"
            [theme]="buttonTheme.LIGHT_GREY"
            [type]="buttonType.TERNARY"
            (clickEvent)="showDeleteWarningPopup = false"
          ></autom-button>

          <autom-button
            [label]="'Da, izbriši'"
            [theme]="buttonTheme.DEFAULT"
            [type]="buttonType.PRIMARY"
            (clickEvent)="removeAttributes()"
          ></autom-button>
        </div>
      </div>
    </div>
  </div>
</autom-popup>

<autom-popup
  *ngIf="showImageDeleteWarningPopup"
  class="logout-popup"
  [height]="sizeEnum.AUTO"
  [position]="positionEnum.CENTER"
  [rounded]="true"
  [subPosition]="positionEnum.CENTER"
  [width]="sizeEnum.MEDIUM"
>
  <div custom-body class="confirmation-container">
    <div class="confirmation-container__icon">
      <autom-icon
        class="confirmation-container__icon--circle"
        [source]="iconEnum.ALERT_TRIANGLE"
      ></autom-icon>
    </div>
    <div class="confirmation-container__main">
      <div class="confirmation-container__header">
        <h2 class="h2">Obaveštenje</h2>
      </div>
      <div class="confirmation-container__body">
        <h5>Da li ste sigurni da želite da se izbrišete sliku artikla?</h5>
      </div>
      <div class="confirmation-container__footer">
        <div>
          <autom-button
            class="warning-popup__cancel-button"
            [label]="'Odustani'"
            [theme]="buttonTheme.LIGHT_GREY"
            [type]="buttonType.TERNARY"
            (clickEvent)="showImageDeleteWarningPopup = false"
          ></autom-button>

          <autom-button
            [label]="'Da, izbriši'"
            [theme]="buttonTheme.DEFAULT"
            [type]="buttonType.PRIMARY"
            (clickEvent)="removeImage()"
          ></autom-button>
        </div>
      </div>
    </div>
  </div>
</autom-popup>
