<div
  class="product-card"
  role="button"
  tabindex="0"
  [attr.aria-label]="
    (roba.proizvodjac?.naziv || '') + ' ' + (roba.naziv || 'Artikal')
  "
  [attr.aria-disabled]="!canNavigateToDetails ? 'true' : null"
>
  <!-- Badge: popust (gore desno) -->
  <div class="discount-badge" *ngIf="showDiscount">-{{ discountLabel }}%</div>

  <!-- Ikonica: u korpi (gore levo) -->
  <div
    class="in-cart-indicator"
    *ngIf="isInCart"
    aria-label="Artikal je u korpi"
  >
    <autom-icon
      [color]="colorEnum.GREEN_700"
      [source]="iconEnum.SHOPPING_BAG"
      [tooltip]="{ tooltipText: 'Artikal je u korpi' }"
    ></autom-icon>
  </div>

  <!-- Slika -->
  <div class="product-image" (click)="handleClick()">
    <img
      [src]="getProductImageSrc()"
      [alt]="getProductImageAlt()"
      [title]="getProductImageTitle()"
      loading="lazy"
    />
  </div>

  <!-- Detalji -->
  <div class="product-details">
    <h3 class="product-title" (click)="handleClick()">
      <ng-container *ngIf="canNavigateToDetails; else plainTitle">
        <a
          [routerLink]="['/webshop', getRouteParam(roba)]"
          [attr.href]="'/webshop/' + getRouteParam(roba)"
        >
          {{ roba.proizvodjac?.naziv }} {{ roba.naziv }}
        </a>
      </ng-container>
      <ng-template #plainTitle>
        <span>{{ roba.proizvodjac?.naziv }} {{ roba.naziv }}</span>
      </ng-template>
    </h3>

    <p class="product-katbr" *ngIf="roba.katbr">Kat. broj: {{ roba.katbr }}</p>
  </div>

  <!-- Cene -->
  <div class="product-price" aria-label="Cene">
    <ng-container *ngIf="availabilityVm.priceVerified; else unverifiedPrice">
      <!-- Stara cena (diskretna, siva, precrtana) -->
      <p *ngIf="showDiscount && oldPrice" class="old-price">
        {{ oldPrice | rsdCurrency }}
      </p>

      <!-- Finalna cena (primarna) -->
      <p class="final-price">
        {{ availabilityVm.displayPrice | rsdCurrency }}
      </p>
      <!-- Mali tekst: cena sa PDV-om -->
      <p class="price-note">Cena sa PDV-om</p>
      <p *ngIf="availabilityVm.provider.coreCharge" class="price-note">
        Kaucija: {{ availabilityVm.provider.coreCharge | rsdCurrency }}
      </p>

      <!-- Ušteda (opciono, diskretno) -->
      <p *ngIf="showDiscount && savings" class="saving">
        Ušteda {{ savings | rsdCurrency }}
      </p>
    </ng-container>
    <ng-template #unverifiedPrice>
      <p class="final-price">Cena nije proverena</p>
      <p class="price-note">Proveri pre poručivanja</p>
    </ng-template>
  </div>

  <!-- Cena po jedinici (npr. /L) -->
  <p *ngIf="unitPrice && availabilityVm.priceVerified" class="unit-price">
    ~ {{ unitPrice | rsdCurrency }} / L
  </p>

  <!-- Stanje -->
  <div
    class="product-stock"
    [ngClass]="{
      green: availabilityVm.tone === 'green',
      blue: availabilityVm.tone === 'blue',
      red: availabilityVm.tone === 'red',
      yellow: availabilityVm.tone === 'yellow'
    }"
  >
    <div class="product-stock__label">{{ availabilityVm.label }}</div>
    <div class="product-stock__sub" *ngIf="availabilityVm.showProviderBox">
      <span *ngIf="availabilityVm.provider.deliveryLabel"
        >Isporuka: {{ availabilityVm.provider.deliveryLabel }}</span
      >
    </div>
  </div>

  <!-- Količina i korpa (sakriveno za TecDoc-only) -->
  <div class="product-actions" *ngIf="canAddToCart">
    <autom-input-fields
      [clearBtn]="false"
      [disableInput]="isOutOfStock"
      [customClass]="'quantity-size'"
      [max]="availableStock || quantityMin"
      [min]="quantityMin"
      [roundOff]="true"
      [size]="sizeEnum.MEDIUM"
      [type]="inputTypeEnum.QUANTITY"
      [validators]="[
        { name: 'max', value: availableStock || quantityMin },
        { name: 'min', value: quantityMin }
      ]"
      [step]="quantityStep"
      [value]="quantity"
      (emitSelected)="modifyQuantity($event)"
      ngDefaultControl
    ></autom-input-fields>

    <autom-button
      [disabled]="isOutOfStock"
      [iconColor]="colorEnum.INFO_25_FILL"
      [iconPrefix]="true"
      [iconSource]="iconEnum.SHOPPING_CART"
      [label]="'Dodaj u korpu'"
      (clickEvent)="handleAddToCart($event)"
    ></autom-button>
  </div>
</div>
