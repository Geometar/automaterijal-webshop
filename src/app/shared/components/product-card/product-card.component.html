<div
  class="product-card"
  role="button"
  tabindex="0"
  [attr.aria-label]="
    (roba.proizvodjac?.naziv || '') + ' ' + (roba.naziv || 'Artikal')
  "
  [attr.aria-disabled]="isTecDocOnly ? 'true' : null"
>
  <!-- Badge: popust (gore desno) -->
  <div class="discount-badge" *ngIf="hasDiscount">-{{ roba.rabat }}%</div>

  <!-- Ikonica: u korpi (gore levo) -->
  <div
    class="in-cart-indicator"
    *ngIf="isInCart"
    aria-label="Artikal je u korpi"
  >
    <autom-icon
      [color]="colorEnum.GREEN_700"
      [source]="iconEnum.SHOPPING_BAG"
      [tooltip]="{ tooltipText: 'Artikal je u korpi' }"
    ></autom-icon>
  </div>

  <!-- Slika -->
  <div class="product-image" (click)="handleClick()">
    <img
      [src]="
        roba.slika?.slikeByte
          ? 'data:image/jpeg;base64,' + roba.slika!.slikeByte!
          : roba.slika?.slikeUrl || '/assets/images/fallback.jpg'
      "
      [alt]="(roba.proizvodjac?.naziv || '') + ' ' + (roba.naziv || 'Artikal')"
      loading="lazy"
    />
  </div>

  <!-- Detalji -->
  <div class="product-details">
    <h3 class="product-title" (click)="handleClick()">
      <a [routerLink]="['/webshop', roba.robaid + '-' + getProductSlug(roba)]">
        {{ roba.proizvodjac?.naziv }} {{ roba.naziv }}
      </a>
    </h3>

    <p class="product-katbr" *ngIf="roba.katbr">Kat. broj: {{ roba.katbr }}</p>
  </div>

  <!-- Cene -->
  <div class="product-price" aria-label="Cene">
    <!-- Stara cena (diskretna, siva, precrtana) -->
    <p *ngIf="hasDiscount && oldPrice" class="old-price">
      {{ oldPrice | rsdCurrency }}
    </p>

    <!-- Finalna cena (primarna) -->
    <p class="final-price">
      {{ roba.cena! | rsdCurrency }}
    </p>
    <!-- Mali tekst: cena sa PDV-om -->
    <p class="price-note">Cena sa PDV-om</p>

    <!-- Ušteda (opciono, diskretno) -->
    <p *ngIf="hasDiscount && savings" class="saving">
      Ušteda {{ savings | rsdCurrency }}
    </p>
  </div>

  <!-- Cena po jedinici (npr. /L) -->
  <p *ngIf="unitPrice" class="unit-price">
    ~ {{ unitPrice | rsdCurrency }} / L
  </p>

  <!-- Stanje -->
  <div
    class="product-stock"
    [ngClass]="{ green: !isOutOfStock, red: isOutOfStock }"
  >
    {{ stockLabel }}
  </div>

  <!-- Količina i korpa (sakriveno za TecDoc-only) -->
  <div class="product-actions" *ngIf="!isTecDocOnly">
    <autom-input-fields
      [clearBtn]="false"
      [disableInput]="isOutOfStock"
      [customClass]="'quantity-size'"
      [max]="roba.stanje || 1"
      [min]="1"
      [roundOff]="true"
      [size]="sizeEnum.MEDIUM"
      [type]="inputTypeEnum.QUANTITY"
      [validators]="[
        { name: 'max', value: roba.stanje || 1 },
        { name: 'min', value: 1 }
      ]"
      [step]="1"
      [value]="quantity"
      (emitSelected)="modifyQuantity($event)"
      ngDefaultControl
    ></autom-input-fields>

    <autom-button
      [label]="'Dodaj u korpu'"
      [iconSource]="iconEnum.SHOPPING_CART"
      [iconPrefix]="true"
      [disabled]="isOutOfStock"
      [iconColor]="colorEnum.INFO_25_FILL"
      (clickEvent)="handleAddToCart($event)"
    ></autom-button>
  </div>
</div>
