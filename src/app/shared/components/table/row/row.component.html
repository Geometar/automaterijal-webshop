<article class="row-container">
  <!-- Image Section -->
  <div class="image-container" [class.image-smaller]="showPriceOnly">
    <!-- Popust badge -->
    <div
      class="discount-badge"
      *ngIf="!isAdminCartView && !isTecDocOnly && data.rabat"
    >
      -{{ data.rabat }}%
    </div>

    <img
      class="clickable-image"
      [alt]="getProductImageAlt()"
      [title]="getProductImageTitle()"
      [src]="getProductImageSrc()"
      decoding="async"
      height="180"
      loading="lazy"
      width="200"
      (click)="openImageZoom(getProductImageSrc())"
    />
  </div>

  <!-- Details Section -->
  <div class="details-container">
    <h3 class="product-heading" [class.disabled]="!canNavigateToDetails">
      <ng-container *ngIf="canNavigateToDetails; else plainHeading">
        <a
          class="product-link"
          [routerLink]="['/webshop', getRouteParam(data)]"
          [attr.href]="'/webshop/' + getRouteParam(data)"
        >
          <span class="product-link__brand">
            {{ data.proizvodjac?.naziv }}</span
          >
          <span class="product-name-fragment">{{
            nameWithoutManufacturer
          }}</span>
          <span class="product-link__chev" aria-hidden="true">›</span>
        </a>
      </ng-container>
      <ng-template #plainHeading>
        <span class="product-link" role="text">
          <span class="product-link__brand">
            {{ data.proizvodjac?.naziv }}</span
          >
          <span class="product-name-fragment">{{
            nameWithoutManufacturer
          }}</span>
        </span>
      </ng-template>
    </h3>

    <div class="product-meta">
      <autom-meta-pill
        *ngIf="data.katbr"
        class="product-meta__sku"
        variant="neutral"
        size="md"
        prefix="#"
        [value]="data.katbr"
        [ariaLabel]="'Kataloški broj ' + data.katbr"
      ></autom-meta-pill>

      <ng-container *ngIf="categoryLabel as label">
        <ng-container
          *ngIf="categoryHref && !disableCategoryNavigation; else plainCategory"
        >
          <autom-meta-pill
            class="product-meta__category category-pill"
            variant="primary"
            size="md"
            [routerLink]="categoryLinkSegments"
            [suffix]="categorySuffix"
            [ariaLabel]="categoryAriaLabel"
          >
            <span class="category-pill__group" *ngIf="data?.grupaNaziv">{{
              data.grupaNaziv
            }}</span>
            <span
              class="category-pill__separator"
              *ngIf="data?.grupaNaziv && data?.podGrupaNaziv"
              aria-hidden="true"
            >
              /
            </span>
            <span class="category-pill__sub" *ngIf="data?.podGrupaNaziv">{{
              data.podGrupaNaziv
            }}</span>
          </autom-meta-pill>
        </ng-container>
        <ng-template #plainCategory>
          <autom-meta-pill
            class="product-meta__category category-pill"
            variant="primary"
            size="md"
            [style.cursor]="disableCategoryNavigation ? 'pointer' : null"
            [attr.aria-label]="
              disableCategoryNavigation
                ? 'Filtriraj po podgrupi ' + label
                : null
            "
            [ngClass]="{ 'clickable-placeholder': disableCategoryNavigation }"
            (click)="onCategoryClick($event)"
          >
            {{ label }}
          </autom-meta-pill>
        </ng-template>
      </ng-container>

      <autom-meta-pill
        *ngIf="showPriceOnly && !isAdminCartView && availabilityVm.showProviderBox"
        variant="accent"
        size="md"
        [value]="'Eksterni magacin'"
        [attr.title]="'Artikal stiže iz eksternog magacina.'"
        [ariaLabel]="'Eksterni magacin'"
      ></autom-meta-pill>

      <autom-meta-pill
        *ngIf="showPriceOnly && isAdminCartView && warehouseLabel"
        variant="accent"
        size="md"
        [value]="warehouseLabel"
        [attr.title]="'Magacin za porucivanje'"
        [ariaLabel]="'Magacin ' + warehouseLabel"
      ></autom-meta-pill>

      <autom-meta-pill
        *ngIf="
          showPriceOnly &&
          !isAdminCartView &&
          availabilityVm.showProviderBox &&
          availabilityVm.provider.deliveryLabel
        "
        variant="soft"
        size="md"
        [label]="'Isporuka'"
        [value]="availabilityVm.provider.deliveryLabel"
        [attr.title]="'Procena isporuke za ovaj artikal.'"
        [ariaLabel]="'Isporuka ' + availabilityVm.provider.deliveryLabel"
      ></autom-meta-pill>
    </div>

    <p *ngIf="isEmployee">
      Stanje:
      <span class="color--figma-primary-800 display--inline font-medium">
        {{ effectiveStock }}
      </span>
    </p>

    <!-- Specifikacije -->
    <section *ngIf="!showPriceOnly" class="specifications-wrapper">
      <table
        *ngIf="displayedSpecs.length; else noSpecsTemplate"
        class="specifications"
        [attr.id]="specTableId"
        aria-label="Specifikacije artikla"
      >
        <tbody>
          <tr *ngFor="let spec of displayedSpecs">
            <td [class.color--figma-highlight-orange]="spec.type === 'A'">
              {{ spec.oznaka }}
              <span *ngIf="spec.jedinica" class="display--inline">[</span>
              {{ spec.jedinica }}
              <span *ngIf="spec.jedinica" class="display--inline">]</span>
            </td>
            <td
              class="autom-align__right"
              [class.color--figma-highlight-orange]="spec.type === 'A'"
            >
              {{ spec.vrednost }}
            </td>
          </tr>
        </tbody>
      </table>

      <ng-template #noSpecsTemplate>
        <p class="no-specs" aria-label="Specifikacije nisu dostupne">
          <autom-icon
            [source]="iconEnum.INFO"
            class="specs-info-icon"
          ></autom-icon>
          <span>Specifikacije nisu dostupne za ovaj artikal.</span>
        </p>
      </ng-template>
    </section>

    <!-- Expand/Collapse Button -->
    <div class="spec-toggle-btn" *ngIf="hasMoreThanFiveSpecs">
      <autom-button
        [type]="buttonType.TERNARY"
        [label]="showAllSpecs ? 'Prikaži manje' : 'Prikaži više'"
        [attr.aria-expanded]="showAllSpecs"
        [attr.aria-controls]="specTableId"
        (click)="toggleSpecifications()"
      >
      </autom-button>
    </div>
  </div>

  <!-- Add to basket Section -->
  <div class="pricing-container" *ngIf="showAddToBasket">
    <!-- Status -->
    <div [ngClass]="['item-status', availabilityVm.tone]">
      <span class="item-status__text">{{ availabilityVm.label }}</span>
      <span class="item-status__dot" aria-hidden="true"></span>
    </div>

    <div
      *ngIf="isInCartItem"
      class="autom-flexbox autom-justify-content--flex-end"
      role="status"
      aria-live="polite"
      style="margin-top: 6px"
    >
      <autom-icon
        aria-label="Artikal je već dodat u korpu"
        [color]="colorEnum.GREEN_700"
        [source]="iconEnum.SHOPPING_BAG"
        [tooltip]="{ tooltipText: 'Artikal je u korpi' }"
      ></autom-icon>
    </div>

    <!-- Eksterna dostupnost (dobavljač) -->
    <div class="provider-availability" *ngIf="availabilityVm.showProviderBox">
      <div
        class="provider-availability__row"
        *ngIf="availabilityVm.provider.deliveryLabel"
      >
        Isporuka: {{ availabilityVm.provider.deliveryLabel }}
      </div>
      <div
        class="provider-availability__row"
        *ngIf="availabilityVm.provider.cutoffLabel"
      >
        Poruči do: {{ availabilityVm.provider.cutoffLabel }}
      </div>
      <div
        class="provider-availability__row provider-availability__admin"
        *ngIf="availabilityVm.provider.admin.sourceLabel"
      >
        Izvor:
        <span class="provider-availability__value">{{
          availabilityVm.provider.admin.sourceLabel
        }}</span>
      </div>
      <div
        class="provider-availability__row provider-availability__purchase"
        *ngIf="availabilityVm.provider.admin.purchasePriceLabel"
      >
        Nabavna:
        <span class="provider-availability__value">{{
          availabilityVm.provider.admin.purchasePriceLabel
        }}</span>
      </div>
    </div>
    <!-- Stara cena -->
    <p *ngIf="availabilityVm.showDiscount" class="sub-price old-price">
      {{ availabilityVm.displayPrice / (1 - data.rabat / 100) | rsdCurrency }}
    </p>

    <!-- Finalna cena -->
    <p *ngIf="!isTecDocOnly" class="price">
      {{
        availabilityVm.displayPrice
          ? (availabilityVm.displayPrice | rsdCurrency)
          : (0 | rsdCurrency)
      }}
    </p>

    <p *ngIf="!isTecDocOnly" class="mobile-row autom-align__right">
      Cena sa PDV-om
    </p>

    <!-- Ušteda -->
    <p *ngIf="availabilityVm.showDiscount" class="saving">
      Ušteda
      {{
        availabilityVm.displayPrice / (1 - data.rabat / 100) -
          availabilityVm.displayPrice | rsdCurrency
      }}
    </p>

    <div
      class="mobile-quantity-cart util__flex--center"
      *ngIf="canAddToCart && !isUnavailable"
    >
      <autom-input-fields
        [clearBtn]="false"
        [disableInput]="isUnavailable"
        [customClass]="'quantity-size'"
        [max]="effectiveStock || 1"
        [min]="1"
        [roundOff]="true"
        [size]="sizeEnum.MEDIUM"
        [type]="inputTypeEnum.QUANTITY"
        [validators]="[
          { name: 'max', value: effectiveStock || 1 },
          { name: 'min', value: 1 }
        ]"
        [step]="1"
        [value]="quantity"
        (emitSelected)="modifyQuantity($event)"
        ngDefaultControl
      ></autom-input-fields>

      <autom-button
        mat-raised-button
        color="primary"
        [disabled]="isUnavailable"
        [iconColor]="colorEnum.INFO_25"
        [iconPrefix]="true"
        [iconSource]="iconEnum.SHOPPING_CART"
        [label]="'Dodaj u korpu'"
        (clickEvent)="addToShoppingCart(data)"
      />
    </div>

    <div *ngIf="shouldShowInquiry" class="inquiry-trigger">
      <autom-button
        [iconPrefix]="true"
        [iconSource]="iconEnum.MAIL"
        [label]="inquirySent ? 'Upit poslat' : 'Pošalji upit za nabavku'"
        [disabled]="inquirySent"
        [theme]="buttonTheme.LIGHT_GREY"
        [type]="buttonType.SECONDARY"
        (clickEvent)="openInquiryPopup()"
      ></autom-button>
      <span class="inquiry-trigger__hint" [class.sent]="inquirySent">
        {{
          inquirySent
            ? "Upit poslat — odgovorićemo na tvoj email."
            : availabilityVm.showProviderBox
            ? "Dostupno u eksternom magacinu — pošaljite upit za nabavku."
            : "Nema na stanju — pošaljite upit."
        }}
      </span>
    </div>
  </div>

  <!-- Pricing-only Section -->
  <div class="pricing-container" *ngIf="showPriceOnly">
    <p *ngIf="!isAdminCartView && availabilityVm.showDiscount" class="sub-price old-price">
      {{ availabilityVm.displayPrice / (1 - data.rabat / 100) | rsdCurrency }}
    </p>

    <p class="sub-price final-price">
      {{
        unitPrice ? (unitPrice | rsdCurrency) : (0 | rsdCurrency)
      }}
    </p>

    <p *ngIf="!isAdminCartView && availabilityVm.showDiscount" class="small-explanation saving">
      Ušteda
      {{
        availabilityVm.displayPrice / (1 - data.rabat / 100) -
          availabilityVm.displayPrice | rsdCurrency
      }}
    </p>

    <p class="autom-align__right small-explanation">
      {{ isAdminCartView ? 'Nabavna cena po komadu' : 'Cena po komadu' }}
    </p>

    <div class="util__flex--center">
      <autom-input-fields
        [clearBtn]="false"
        [disableInput]="isUnavailable"
        [customClass]="'quantity-size'"
        [max]="effectiveStock || 1"
        [min]="1"
        [roundOff]="true"
        [size]="sizeEnum.MEDIUM"
        [type]="inputTypeEnum.QUANTITY"
        [validators]="[
          { name: 'max', value: effectiveStock || 1 },
          { name: 'min', value: 1 }
        ]"
        [step]="1"
        [value]="data.kolicina"
        (emitSelected)="modifyQuantity($event)"
        ngDefaultControl
      ></autom-input-fields>

      <div>
        <p class="price">{{ totalPrice | rsdCurrency }}</p>
        <p class="autom-align__right autom-margin__none">
          {{ isAdminCartView ? 'Ukupno bez PDV-a' : 'Ukupno sa PDV-om' }}
        </p>
      </div>
    </div>
  </div>

  <!-- CloseBtn Section -->
  <div class="remove-icon" *ngIf="showCloseBtn">
    <autom-icon
      [tooltip]="{ tooltipText: 'Izbrisi iz korpe' }"
      [source]="iconEnum.X"
      (click)="cartKey && removeEvent.emit(cartKey)"
    ></autom-icon>
  </div>
</article>

<app-inquiry-dialog
  [open]="inquiryPopupOpen"
  [productName]="data.naziv || ''"
  [manufacturer]="data.proizvodjac?.naziv"
  [katbr]="data.katbr"
  [robaId]="data.robaid"
  [prefilledEmail]="loggedIn ? inquiryContact : null"
  [loggedIn]="loggedIn"
  (closed)="closeInquiryPopup()"
  (sent)="inquirySent = true; inquiryPopupOpen = false"
></app-inquiry-dialog>

<!-- Overlay za zoom -->
<div
  class="image-zoom-overlay"
  *ngIf="zoomedImageUrl"
  role="dialog"
  aria-modal="true"
  aria-label="Uvećana slika"
  (click)="zoomedImageUrl = null"
  (keydown.escape)="zoomedImageUrl = null"
  tabindex="0"
>
  <img
    class="zoomed-image"
    [src]="zoomedImageUrl"
    [alt]="getProductImageAlt()"
    [title]="getProductImageTitle()"
    (click)="$event.stopPropagation()"
  />
</div>
