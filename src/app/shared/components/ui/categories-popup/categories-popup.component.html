<autom-popup
  class="categories-popup"
  [height]="sizeEnum.FULL_VH"
  [position]="positionEnum.LEFT"
  [rounded]="true"
  [width]="sizeEnum.LARGE"
  (close)="close.emit()"
>
  <!-- ========== HEADER / HERO ========== -->
  <div custom-header class="cp-header">
    <div class="cp-hero">
      <div class="cp-hero__title cp-header--main">
        <div>
          <h3 class="cp-title">Kategorije</h3>
          <p class="cp-subtitle">
            Brzo pronaƒëi maziva, pribor, alate ili filtere. Za autodelove
            koristi pretragu po vozilu.
          </p>
        </div>

        <button
          class="cp-close"
          type="button"
          (click)="close.emit()"
          aria-label="Zatvori"
        >
          ‚úï
        </button>
      </div>

      <div class="cp-hero__actions">
        <!-- Search -->
        <autom-input-fields
          class="cp-search"
          [type]="inputTypeEnum.SEARCH"
          placeholder="Pretra≈æi grupe‚Ä¶"
          (emitSelected)="onSearch($event)"
          aria-label="Pretraga kategorija"
        ></autom-input-fields>

        <!-- TecDoc CTA -->
        <button
          class="btn-cta"
          type="button"
          (click)="
            selected.emit({
              kind: 'group',
              groupId: 'TECDOC',
              groupName: 'TecDoc'
            })
          "
        >
          Pretra≈æi po vozilu
        </button>
      </div>
    </div>
  </div>

  <!-- ========== BODY ========== -->
  <div custom-body class="cp-body">
    <!-- LEFT: Buckets & Groups -->
    <aside class="cp-left">
      <ng-container *ngIf="vm$ | async as buckets">
        <section
          class="bucket"
          *ngFor="let bucket of buckets; trackBy: trackBucket"
          [attr.aria-label]="bucket.label"
        >
          <div class="bucket__header">
            <h4 class="bucket__title">{{ bucket.label }}</h4>
            <span class="bucket__count" *ngIf="bucket.groups?.length">{{
              bucket.groups.length
            }}</span>
          </div>

          <ul class="group-list">
            <li
              class="group-item"
              *ngFor="let group of bucket.groups; trackBy: trackGroup"
              [class.is-active]="activeGroup?.code === group.code"
              (click)="selectGroup(group)"
              tabindex="0"
              (keyup.enter)="selectGroup(group)"
              [attr.aria-label]="group.name"
            >
              <div class="group-item__inner fade-in">
                <div class="group-item__title">
                  <!-- ikonica iz override-a ako je doda≈° (nije obavezno) -->
                  <autom-icon
                    *ngIf="group.icon"
                    [source]="group.icon"
                    class="group-item__icon"
                  ></autom-icon>
                  <span class="group-item__name">{{ group.name }}</span>
                </div>
                <span class="group-item__chev">‚Ä∫</span>
              </div>
            </li>
          </ul>
        </section>

        <!-- Empty state kad filter ne naƒëe ni≈°ta -->
        <div class="empty-state" *ngIf="!hasAnyGroups(buckets)">
          <div class="empty-state__card fade-in">
            <div class="empty-state__icon">ü§∑‚Äç‚ôÇÔ∏è</div>
            <div class="empty-state__text">
              Nema rezultata za taj upit. Poku≈°aj drugim pojmom.
            </div>
          </div>
        </div>
      </ng-container>
    </aside>

    <!-- RIGHT: Subgroups (shows when a group is selected) -->
    <section class="cp-right" *ngIf="activeGroup as g">
      <header class="group-head slide-in">
        <div class="group-head__left">
          <button
            class="btn-back"
            type="button"
            (click)="activeGroup = null"
            aria-label="Nazad na grupe"
          >
            ‚Äπ
          </button>
          <h4 class="group-title">{{ g.name }}</h4>
        </div>
        <button class="btn-outline" type="button" (click)="pickGroup(g)">
          Prika≈æi sve iz grupe
        </button>
      </header>

      <div class="subgrid">
        <button
          class="subcard fade-in"
          *ngFor="let sub of g.subgroups; trackBy: trackSub"
          type="button"
          (click)="pickSubgroup(g, sub)"
          [attr.aria-label]="sub.name"
        >
          <span class="subcard__name">{{ sub.name }}</span>
          <span class="subcard__chev">‚Ä∫</span>
        </button>
      </div>

      <!-- fallback kad grupa nema podgrupe -->
      <div class="empty-subgroups fade-in" *ngIf="!g.subgroups?.length">
        <p>Ova grupa trenutno nema podgrupe.</p>
        <button class="btn-outline" type="button" (click)="pickGroup(g)">
          Otvori celu grupu
        </button>
      </div>
    </section>
  </div>
</autom-popup>
